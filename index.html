<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Gr√°ficos D3</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 2rem;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .card {
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    svg {
      border: 1px solid #ccc;
      background-color: #e9ecef;
      margin-top: 10px;
    }

    h3 {
      margin: 0;
      margin-bottom: 10px;
      font-size: 1.1rem;
      color: #343a40;
    }
  </style>
</head>
<body>
  <h1 style="text-align:center;">Dashboard Interactivo con D3.js</h1>
  <div class="container">
    <!-- Coordenadas -->
    <div class="card">
      <h3>Coordenadas del Mouse</h3>
      <svg id="coords" width="300" height="300"></svg>
    </div>

    <!-- Brush con CSV -->
    <div class="card">
      <h3>Brush con Dos Colores</h3>
      <svg id="brush1" width="300" height="300"></svg>
      <svg id="brush2" width="300" height="300"></svg>
    </div>

    <!-- Drag and Drop -->
    <div class="card">
      <h3>Drag and Drop</h3>
      <svg id="dragdrop" width="600" height="200">
        <circle cx="100" cy="100" r="20" fill="red"></circle>
        <circle cx="300" cy="100" r="20" fill="green"></circle>
        <circle cx="500" cy="100" r="20" fill="blue"></circle>
      </svg>
    </div>

    <!-- Stagger Bars -->
    <div class="card">
      <h3>Stagger Bars</h3>
      <svg id="stagger" width="600" height="300"></svg>
    </div>

    <!-- Lissajous Curve -->
    <div class="card">
      <h3>Curva de Lissajous</h3>
      <svg id="lissajous" width="300" height="300"></svg>
    </div>
  </div>

  <script>
    // === Coordenadas ===
    function coordsPixels(selector) {
      var txt = d3.select(selector).append('text')
        .attr('font-family', 'Arial, sans-serif')
        .attr('font-size', '12px')
        .attr('fill', 'black');

      var svg = d3.select(selector)
        .attr('cursor', 'crosshair')
        .on('mousemove', function() {
          var pt = d3.mouse(svg.node());
          txt.attr('x', 18 + pt[0])
            .attr('y', 6 + pt[1])
            .text('(' + Math.round(pt[0]) + ', ' + Math.round(pt[1]) + ')');
        })
        .on('mouseleave', function() {
          txt.text('');
        });
    }

    coordsPixels('#coords');

    // === Brush con CSV ===
    fetch("data/dense.csv")
      .then(res => res.text())
      .then(text => {
        const rows = d3.csvParse(text);
        const data = rows.map(d => ({ A: +d.A, B: +d.B }));

        const svg1 = d3.select("#brush1"),
              svg2 = d3.select("#brush2");

        const sc1 = d3.scaleLinear().domain([0, 10, 50]).range(["lime", "yellow", "red"]);
        const sc2 = d3.scaleLinear().domain([0, 10, 50]).range(["lime", "yellow", "blue"]);

        const cs1 = drawCircles(svg1, data, d => d.A, d => d.B, sc1);
        const cs2 = drawCircles(svg2, data, d => d.A, d => d.B, sc2);

        svg1.call(installHandlers, data, cs1, cs2, sc1, sc2);
      });

    function drawCircles(svg, data, accX, accY, sc) {
      return svg.selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .attr("r", 5)
        .attr("cx", accX)
        .attr("cy", accY)
        .attr("fill", sc(Infinity))
        .attr("fill-opacity", 0.4);
    }

    function installHandlers(svg, data, cs1, cs2, sc1, sc2) {
      svg.attr("cursor", "crosshair")
        .on("mousemove", function() {
          const pt = d3.mouse(svg.node());
          cs1.attr("fill", function(d, i) {
            const r = Math.hypot(pt[0] - this.cx.baseVal.value, pt[1] - this.cy.baseVal.value);
            data[i].r = r;
            return sc1(r);
          });
          cs2.attr("fill", (d, i) => sc2(data[i].r));
        })
        .on("mouseleave", function() {
          cs1.attr("fill", sc1(Infinity));
          cs2.attr("fill", sc2(Infinity));
        });
    }

    // === Drag and Drop ===
    function makeDragDrop() {
      let widget = undefined, color = undefined;

      const drag = d3.drag()
        .on("start", function() {
          color = d3.select(this).attr("fill");
          widget = d3.select(this).attr("fill", "lime");
        })
        .on("drag", function() {
          const pt = d3.mouse(d3.select("#dragdrop").node());
          widget.attr("cx", pt[0]).attr("cy", pt[1]);
        })
        .on("end", function() {
          widget.attr("fill", color);
          widget = undefined;
        });

      drag(d3.select("#dragdrop").selectAll("circle"));
    }

    setTimeout(makeDragDrop, 100);

    // === Stagger ===
    function makeStagger() {
      let ds1 = [2, 1, 3, 5, 7, 8, 9, 9, 9, 8, 7, 5, 3, 1, 2];
      let ds2 = [8, 9, 8, 7, 5, 3, 2, 1, 2, 3, 5, 7, 8, 9, 8];

      const svg = d3.select("#stagger");
      const scX = d3.scaleLinear().domain([0, ds1.length]).range([50, 540]);
      const scY = d3.scaleLinear().domain([0, d3.max([...ds1, ...ds2])]).range([250, 50]);

      svg.selectAll("line")
        .data(ds1)
        .enter()
        .append("line")
        .attr("stroke", "red")
        .attr("stroke-width", 20)
        .attr("x1", (d, i) => scX(i))
        .attr("y1", scY(0))
        .attr("x2", (d, i) => scX(i))
        .attr("y2", d => scY(d));

      svg.on("click", function () {
        [ds1, ds2] = [ds2, ds1];
        svg.selectAll("line")
          .data(ds1)
          .transition()
          .duration(1000)
          .delay((d, i) => 200 * i)
          .attr("y2", d => scY(d));
      });
    }

    makeStagger();

    // === Lissajous ===
    function makeLissajous() {
      const svg = d3.select("#lissajous");

      const a = 1.9, b = 3.2;
      const omega = 2 * Math.PI / 10000;
      let prvX = 150 + 100, prvY = 150;

      const timer = d3.timer(t => {
        const phi = omega * t;
        const crrX = 150 + 100 * Math.cos(a * phi);
        const crrY = 150 + 100 * Math.sin(b * phi);

        svg.selectAll("line")
          .each(function() { this.bogus_opacity *= 0.99; })
          .attr("stroke-opacity", function() { return this.bogus_opacity; })
          .filter(function() { return this.bogus_opacity < 0.05; })
          .remove();

        svg.append("line")
          .each(function() { this.bogus_opacity = 1.0; })
          .attr("x1", prvX).attr("y1", prvY)
          .attr("x2", crrX).attr("y2", crrY)
          .attr("stroke", "green").attr("stroke-width", 2);

        prvX = crrX;
        prvY = crrY;

        if (t > 120000) timer.stop();
      });
    }

    makeLissajous();
  </script>
</body>
</html>
