<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard con D3.js</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    .chart-container {
      margin-bottom: 40px;
    }
    svg {
      background: lightgrey;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Dashboard Interactivo con D3.js</h1>

  <!-- Coordenadas del mouse -->
  <div class="chart-container">
    <h3>1. Coordenadas del Mouse</h3>
    <svg id="coords" width="300" height="300"></svg>
  </div>

  <!-- Brush con datos desde CSV -->
  <div class="chart-container">
    <h3>2. Brush con Datos desde CSV</h3>
    <svg id="brush1" width="300" height="300"></svg>
    <svg id="brush2" width="300" height="300"></svg>
  </div>

  <!-- Drag & Drop -->
  <div class="chart-container">
    <h3>3. Drag and Drop</h3>
    <svg id="dragdrop" width="600" height="200">
      <circle cx="100" cy="100" r="20" fill="red"></circle>
      <circle cx="300" cy="100" r="20" fill="green"></circle>
      <circle cx="500" cy="100" r="20" fill="blue"></circle>
    </svg>
  </div>

  <!-- Stagger Bars -->
  <div class="chart-container">
    <h3>4. Gráfico Stagger Interactivo</h3>
    <svg id="stagger" width="600" height="300"></svg>
  </div>

  <!-- Lissajous -->
  <div class="chart-container">
    <h3>5. Trayectoria Lissajous</h3>
    <svg id="lissajous" width="300" height="300"></svg>
  </div>

  <script>
    // 1. Coordenadas del Mouse
    function coordsPixels(selector) {
      var txt = d3.select(selector).append('text')
        .attr('font-family', 'Arial')
        .attr('font-size', '12px')
        .attr('fill', 'black');

      var svg = d3.select(selector)
        .attr('cursor', 'crosshair')
        .on('mousemove', function() {
          var pt = d3.mouse(svg.node());
          txt.attr('x', 18 + pt[0])
             .attr('y', 6 + pt[1])
             .text('(' + Math.round(pt[0]) + ', ' + Math.round(pt[1]) + ')');
        })
        .on('mouseleave', function() {
          txt.text('');
        });
    }
    coordsPixels("#coords");

    // 2. Brush con datos CSV
    d3.csv("https://github.com/AnaPauR/primerinformed3/blob/8b2b336def0cb6c941977a787a38c3bba94b10fc/dense.csv").then(function(data) {
      var svg1 = d3.select("#brush1"),
          svg2 = d3.select("#brush2");

      var sc1 = d3.scaleLinear().domain([0, 10, 50]).range(["lime", "yellow", "red"]);
      var sc2 = d3.scaleLinear().domain([0, 10, 50]).range(["lime", "yellow", "blue"]);

      var cs1 = drawCircles(svg1, data, d => +d.A, d => +d.B, sc1);
      var cs2 = drawCircles(svg2, data, d => +d.A, d => +d.B, sc2);

      svg1.call(installHandlers, data, cs1, cs2, sc1, sc2);

      function drawCircles(svg, data, accX, accY, sc) {
        var color = sc(Infinity);
        return svg.selectAll("circle")
          .data(data)
          .enter()
          .append("circle")
          .attr("r", 5)
          .attr("cx", d => accX(d))
          .attr("cy", d => accY(d))
          .attr("fill", color)
          .attr("fill-opacity", 0.4);
      }

      function installHandlers(svg, data, cs1, cs2, sc1, sc2) {
        svg.attr("cursor", "crosshair")
          .on("mousemove", function() {
            var pt = d3.mouse(svg.node());
            cs1.attr("fill", function(d, i) {
              var r = Math.hypot(pt[0] - d3.select(this).attr("cx"), pt[1] - d3.select(this).attr("cy"));
              data[i]["r"] = r;
              return sc1(r);
            });
            cs2.attr("fill", (d, i) => sc2(data[i]["r"]));
          })
          .on("mouseleave", function() {
            cs1.attr("fill", sc1(Infinity));
            cs2.attr("fill", sc2(Infinity));
          });
      }
    });

    // 3. Drag and Drop
    function makeDragDrop() {
      var widget = undefined, color = undefined;

      var drag = d3.drag()
        .on("start", function() {
          color = d3.select(this).attr("fill");
          widget = d3.select(this).attr("fill", "lime");
        })
        .on("drag", function() {
          var pt = d3.mouse(d3.select("#dragdrop").node());
          widget.attr("cx", pt[0]).attr("cy", pt[1]);
        })
        .on("end", function() {
          widget.attr("fill", color);
          widget = undefined;
        });

      drag(d3.select("#dragdrop").selectAll("circle"));
    }
    makeDragDrop();

    // 4. Gráfico Stagger
    function makeStagger() {
      let ds1 = [2, 1, 3, 5, 7, 8, 9, 9, 9, 8, 7, 5, 3, 1, 2];
      let ds2 = [8, 9, 8, 7, 5, 3, 2, 1, 2, 3, 5, 7, 8, 9, 8];

      const n = ds1.length;
      const mx = d3.max([...ds1, ...ds2]);

      const svg = d3.select("#stagger");

      const scX = d3.scaleLinear().domain([0, n]).range([50, 540]);
      const scY = d3.scaleLinear().domain([0, mx]).range([250, 50]);

      svg.selectAll("line")
        .data(ds1)
        .enter()
        .append("line")
        .attr("stroke", "red")
        .attr("stroke-width", 20)
        .attr("x1", (d, i) => scX(i))
        .attr("y1", scY(0))
        .attr("x2", (d, i) => scX(i))
        .attr("y2", d => scY(d));

      svg.on("click", function () {
        [ds1, ds2] = [ds2, ds1];
        svg.selectAll("line")
          .data(ds1)
          .transition()
          .duration(1000)
          .delay((d, i) => 200 * i)
          .attr("y2", d => scY(d));
      });
    }
    makeStagger();

    // 5. Lissajous
    (function makeLissajous() {
      var svg = d3.select("#lissajous");

      var a = 1.9, b = 3.2;
      var omega = 2 * Math.PI / 10000;

      var prvX = 150 + 100, prvY = 150;

      var timer = d3.timer(function(t) {
        var phi = omega * t;
        var crrX = 150 + 100 * Math.cos(a * phi);
        var crrY = 150 + 100 * Math.sin(b * phi);

        svg.selectAll("line")
          .each(function() { this.bogus_opacity *= 0.99; })
          .attr("stroke-opacity", function() { return this.bogus_opacity; })
          .filter(function() { return this.bogus_opacity < 0.05; })
          .remove();

        svg.append("line")
          .each(function() { this.bogus_opacity = 1.0; })
          .attr("x1", prvX).attr("y1", prvY)
          .attr("x2", crrX).attr("y2", crrY)
          .attr("stroke", "green").attr("stroke-width", 2);

        prvX = crrX;
        prvY = crrY;

        if (t > 120000) { timer.stop(); }
      });
    })();
  </script>
</body>
</html>
